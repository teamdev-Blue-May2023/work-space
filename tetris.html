<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>テトリス</title>
  <style>
    body {
      background-image: url(https://sozaino.site/wp-content/uploads/2021/11/gameneon03.jpg);
      text-align: center;
    }

    #container {
      margin: 0 auto;
    }

    #startButton {
      font-size: 20px;
      border-radius: 15px;
      background-color: #b2d8d8;
    }
  </style>
</head>

<body onload="init()">
  <div id="container">
    <canvas id="cvs"></canvas>
  </div>
  <button id="startButton">Start Game</button>
  <script>
    //ブロック1マスの大きさ
    const blockSize = 30;
    //ボードサイズ
    const boardRow = 20;
    const boardCol = 10;
    //キャンバスの取得
    const cvs = document.getElementById("cvs");
    //2dコンテキストを取得
    const ctx = cvs.getContext("2d");
    //キャンバスサイズ
    const canvasW = blockSize * boardCol;
    const canvasH = blockSize * boardRow;
    cvs.width = canvasW;
    cvs.height = canvasH;
    //コンテナの設定
    const container = document.getElementById("container");
    container.style.width = canvasW + 'px';

    // tetの1辺の長さ
    const tetSize = 4;

    //テトリミノの追加
    const tetTypes = [
      [], //配列のインデックス0は空としておく。
      [
        [0, 0, 0, 1],
        [0, 0, 1, 0],
        [0, 1, 0, 0],
        [1, 0, 0, 0],
      ],
      [
        [0, 0, 0, 0],
        [0, 0, 1, 1],
        [0, 0, 1, 1],
        [0, 0, 0, 0],
      ],
      [
        [0, 0, 0, 0],
        [0, 0, 1, 0],
        [0, 1, 1, 1],
        [0, 0, 0, 0],
      ],
      [
        [0, 0, 0, 0],
        [0, 1, 1, 0],
        [0, 0, 1, 1],
        [0, 0, 0, 0],
      ],
      [
        [0, 0, 0, 0],
        [0, 0, 1, 1],
        [0, 1, 1, 0],
        [0, 0, 0, 0],
      ],
      [
        [0, 0, 0, 0],
        [1, 1, 1, 1],
        [0, 0, 0, 0],
        [0, 0, 0, 0],
      ],
      [
        [0, 0, 0, 0],
        [0, 1, 1, 1],
        [0, 0, 0, 1],
        [0, 0, 0, 0],
      ],
      [
        [0, 0, 0, 0],
        [0, 0, 0, 1],
        [0, 1, 1, 1],
        [0, 0, 0, 0],
      ],
    ];

    //テトリミノの配列に対する色設定
    const tetColors = [
      '', // 0は空のため色もなし
      '#faebd7',
      '#6495ed',
      '#00ff7f',
      '#cd853f',
      '#ff00ff',
      '#4b0082',
      '#f0f8ff',
      '#808000',
    ];

    let tet_idx = 4;
    let tet = tetTypes[tet_idx];

    //ボード本体
    const board = [];

    let offsetX = 0;
    let offsetY = 0;

    //描画処理
    const draw = () => {
      //塗りに黒を設定
      ctx.fillStyle = '#000';
      //キャンバスを塗りつぶす
      ctx.fillRect(0, 0, canvasW, canvasH);

      //ボードに存在しているブロックを塗る
      for (let y = 0; y < boardRow; y++) {
        for (let x = 0; x < boardCol; x++) {
          if (board[y][x]) {
            drawBlock(x, y, board[y][x]);
          }
        }
      }

      // 「移動」「回転」の動作確認のためにテトリミノのサンプルを一つ描画する
      for (let y = 0; y < tetSize; y++) {
        for (let x = 0; x < tetSize; x++) {
          if (tet[y][x]) {
            drawBlock(x, y, tet_idx);
          }
        }
      }
    }

    //回転
    const createRotateTet = () => {
      //新しいtetを作る
      let newTet = [];
      for (let y = 0; y < tetSize; y++) {
        newTet[y] = [];
        for (let x = 0; x < tetSize; x++) {
          //時計回りに90度回転させる
          newTet[y][x] = tet[tetSize - 1 - x][y];
        }
      }
      return newTet;
    };

    document.onkeydown = (e) => {
      switch (e.keyCode) {
        case 37: //左
          if (canMove(-1, 0)) offsetX--;
          break;
        case 39: //右
          if (canMove(1, 0)) offsetX++;
          break;
        case 40: //下
          if (canMove(0, 1)) offsetY++;
          break;
        case 32: //space
          let newTet = createRotateTet();
          if (canMove(0, 0, newTet)) {
            tet = newTet;
          }
      }
      draw();
    };

    // ブロックの描画
    const drawBlock = (x, y, tet_idx) => {
      let px = (offsetX + x) * blockSize;
      let py = (offsetY + y) * blockSize;
      //塗りを設定
      ctx.fillStyle = tetColors[tet_idx];
      ctx.fillRect(px, py, blockSize, blockSize);
      //線を設定
      ctx.strokeStyle = 'black';
      //線を描画
      ctx.strokeRect(px, py, blockSize, blockSize);
    };

    //移動の制限
    const canMove = (dx, dy, nowTet = tet) => {
      for (let y = 0; y < tetSize; y++) {
        for (let x = 0; x < tetSize; x++) {
          //その場所にブロックがあれば
          if (nowTet[y][x]) {
            //ボード座標に変換
            let nx = offsetX + x + dx;
            let ny = offsetY + y + dy;
            if (
              //調査する座標がボード外だったらできない
              ny < 0 ||
              nx < 0 ||
              ny >= boardRow ||
              nx >= boardCol ||
              //移動したいボード上の場所にすでに存在してたらできない
              board[ny][nx]
            ) {
              //移動できない
              return false;
            }
          }
        }
      }
      //移動できる
      return true;
    };

    //初期化処理
    const init = () => {
      //ボード(20*10を0埋め)
      for (let y = 0; y < boardRow; y++) {
        board[y] = [];
        for (let x = 0; x < boardCol; x++) {
          board[y][x] = 0;
        }
      }

      //ゲーム開始の処理
      //Startボタンを押した時の処理
      window.onload = function () {
        document.getElementById("startButton").onclick = function () {
          init();
        };
      };

      draw();
    };
  </script>
</body>

</html>